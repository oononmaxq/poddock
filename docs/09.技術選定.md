# poddock 技術選定.md（Cloudflare構成 / MVP〜拡張）

## 0. 目的

poddock を Cloudflare 上で運用するための技術選定を確定し、実装TODOの前提を固定する。

---

## 1. 結論（採用スタック）

- フロント/管理画面：**Astro**
- API（CRUD/認証/バリデーション）：**Cloudflare Workers**
- RSS配信（XML）：**Cloudflare Workers（同一アプリ内）**
- 音声/画像ストレージ：**Cloudflare R2**
- 音声/画像配信：**Cloudflare CDN（R2 Public + Cache）**
- DB：**Cloudflare D1（MVP） or 外部Postgres（本番想定）**
- ジョブ/非同期：**Cloudflare Queues（MVP後）**
- 定期実行：**Cloudflare Cron Triggers（MVP後）**
- 監視/ログ：**Cloudflare Logs + Sentry（任意）**

> 方針：AstroはUIに専念し、サーバ処理はWorkersへ寄せる（スケールと運用を単純化）

---

## 2. 採用理由（要件との対応）

### 2.1 音声アップロード（MVPで必須）

- 課題：Astro/Workerが音声ファイルを中継するとサイズ制限・タイムアウトのリスク
- 解決：**R2 署名付きURL（Presigned URL）でブラウザ→R2へ直PUT**
- Workerは「署名URL発行」と「アップロード完了登録」だけを担う

### 2.2 音声配信（Range/HEAD）

- 音声配信はアプリでやらず **R2 + CDNに任せる**
- RSSの `<enclosure>` はR2上の安定URLを指す

### 2.3 RSS生成（XML）

- RSSは高頻度でクロールされるため、軽量なエッジ実行（Workers）が適する
- `ETag` / `Last-Modified` を付与してキャッシュ効率を上げる

### 2.4 半自動ディレクトリ連携

- validateはWorkerで実装（DB＋RSS仕様に基づくチェック）
- UIはAstroでウィザード表示、APIはWorkerで結果返却

---

## 3. コンポーネント構成（役割分担）

### 3.1 Astro（UI）

- 管理画面（ログイン、番組、エピソード、配信先タブ）
- API呼び出し（WorkerのREST）
- 画面は静的+CSRでもOK（SEO不要）
- UIコンポーネント：**Tailwind CSS + daisyUI**
  - daisyUIはTailwindベースのコンポーネントライブラリ
  - ボタン、フォーム、モーダル、タブ等を統一的に扱える
  - テーマ切替対応（MVP後のダークモード等に備える）

#### フロントエンド補足

Astro は View Transitions / ClientRouter を利用することで、
MPA構成を維持したまま SPA ライクな画面遷移を実現できる。

これにより、poddock のような
- 管理画面中心
- フォーム操作が多い
- SEOを重視しない

プロダクトにおいて、UI体験と実装シンプルさの両立が可能となる。

### 3.2 Workers（API + RSS）

- `/auth/*`：ログイン（JWT or セッション）
- `/podcasts/*`：番組CRUD
- `/episodes/*`：エピソードCRUD
- `/assets/*`：署名URL発行 / complete / 紐付け
- `/rss/*`：RSS XML生成（公開/非公開token）
- `/validate/*`：RSS要件チェック（Apple/Spotify/Amazon）

### 3.3 R2（Storage）

- `audio/`：音声（MP3/M4A/WAV）
- `images/`：カバー画像
- 公開URLはCDN経由（安定URL設計）

### 3.4 DB（D1 or Postgres）

- エンティティ：
  - Podcast
  - Episode
  - Asset
  - FeedToken
  - DistributionTarget（配信先種別：Apple / Spotify / Amazon の固定マスタ）
  - DistributionStatus
  - AdminUser
- MVP：
  - **D1採用**でCloudflare完結（開発速度）
- 拡張：
  - データ増・運用要件増なら **Postgresへ移行**（スキーマは正規化前提なので移行しやすい）

---

## 4. 認証方針（MVP）

- 単一管理者想定
- 推奨：**JWT（短命Access + 必要ならRefresh）**
- 管理画面のみ認証必須
- RSS取得は公開/非公開tokenのみ（ログイン不要）

---

## 5. MVP後にサーバーレスへ“逃がす”対象

MVPでは必須ではないが、拡張時にWorkers/Queuesへ載せる想定：

- duration自動抽出（ffprobe相当） → Queueジョブ
- 画像リサイズ/最適化 → Worker/Images
- RSS外部到達性チェック（HEAD/Range） → Cron + Queue
- 孤児Asset掃除 → Cron

---

## 6. 主要な設計原則（ブレ止め）

- **アプリが音声を配信しない**（CDN/R2に任せる）
- **アップロードを中継しない**（署名URLで直送）
- **RSSは軽く・速く・キャッシュ前提**
- **正本はDB（Podcast/Episode/Asset）で、RSSは派生物**

---

## 7. 未決事項（この後決めると実装が速い）

- DB：D1で開始するか / 最初からPostgres（Neon等）にするか
- 認証：JWTのみ / refresh導入
- 公開RSSのprivate時挙動：404 or 403（推奨は404）
- R2公開URLの設計（バケット/パス/キャッシュ戦略）
