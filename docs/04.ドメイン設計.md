# ドメイン設計.md（poddock / MVP）

## 1. 目的

poddock MVP のドメインモデル（エンティティ、関係、主要ルール）を定義し、
DB設計・API設計・実装の共通土台とする。

---

## 2. ドメイン境界（Bounded Context）

MVPのドメインは以下のコンテキストで構成する。

1. **Catalog**（番組・エピソードのメタ情報管理）
2. **Media**（音声ファイル管理・配信URL）
3. **Syndication**（RSS生成・公開/非公開・配信先ステータス）
4. **Access**（管理画面ログイン最小構成）

> MVPでは Access は最小（単一管理者）として Catalog/Media/Syndication を優先する。

---

## 3. エンティティ一覧（Entities）

### 3.1 Podcast（番組）

**概要**：RSSの単位。エピソード集合の親。

**主な属性**

- `id`（UUID/ULID）
- `title`
- `description`
- `language`（例: `ja`）
- `category`（1つで開始、将来複数可）
- `author_name`（任意）
- `explicit`（boolean）
- `cover_image_asset_id`（任意）
- `visibility`（`public` | `private`）
- `private_feed_token_id`（任意 / private時に利用）
- `contact_email`（任意）
  - 番組に関する連絡先メールアドレス
  - RSS生成時の `itunes:email` に使用する
- `created_at`, `updated_at`

**ドメインルール**

- `title` は必須
- `visibility=private` の場合、非公開RSSが有効
- Podcastのメタ情報はRSSへ反映される
- `contact_email` は AdminUser.email とは独立した値とする
- Amazon Music への配信を行う場合、`contact_email` は必須項目とする

---

### 3.2 Episode（エピソード）

**概要**：RSSの `<item>` に相当。音声ファイルを1つ持つ。

**主な属性**

- `id`
- `podcast_id`（FK）
- `title`
- `description`（show notes）
- `status`（`draft` | `published`）
- `published_at`（公開日時、`published`時は必須）
- `audio_asset_id`（FK / 1 episode = 1 audio）
- `duration_seconds`（任意、将来自動抽出でもよい）
- `created_at`, `updated_at`

**ドメインルール**

- `draft` はRSSに含めない
- `published` は `published_at` と `audio_asset_id` が必須
- Episodeは必ず1つのPodcastに属する

---

### 3.3 Asset（ファイル資産）

**概要**：音声や画像などの実体ファイルを表す。

**主な属性**

- `id`
- `type`（`audio` | `image`）
- `storage_provider`（`s3` | `r2` | `gcs` 等）
- `storage_bucket`
- `storage_key`
- `public_url`（CDN/直リンク）
- `content_type`（MIME）
- `byte_size`
- `checksum`（任意）
- `created_at`

**ドメインルール**

- `type=audio` の `content_type` は MVPで
  - `audio/mpeg`（MP3）
  - `audio/mp4`（M4A）
  - `audio/wav`（WAV）
    のみ許可
- `type=image` は `image/png` / `image/jpeg` 等（最小でOK）
- `public_url` はRSSで使用されるため安定している必要がある

---

### 3.4 FeedToken（非公開RSSトークン）

**概要**：非公開RSSのアクセス制御に使用するランダムトークン。

**主な属性**

- `id`
- `podcast_id`（FK, unique）
- `token`（長いランダム文字列）
- `revoked_at`（任意）
- `created_at`

**ドメインルール**

- tokenは推測困難（例：32byte以上相当のランダム）
- token再発行時は旧tokenを無効化できる（`revoked_at`）

---

### 3.5 DistributionTarget（配信先種別：マスタ）

**概要**：Apple/Spotify/Amazonなど配信先の種類。固定マスタ。

**主な属性**

- `id`（固定値でも可：`apple`/`spotify`/`amazon`）
- `name`
- `submit_url`（提出先の公式URL ※UI誘導用）
- `created_at`

**ドメインルール**

- MVPでは3件固定（Apple / Spotify / Amazon Music）

---

### 3.6 DistributionStatus（配信先ステータス）

**概要**：Podcast × 配信先の提出状況を保持する。

**主な属性**

- `id`
- `podcast_id`（FK）
- `target_id`（FK -> DistributionTarget）
- `status`（`not_submitted` | `submitted` | `live` | `needs_attention`）
- `note`（任意）
- `last_checked_at`（任意）
- `created_at`, `updated_at`

**ドメインルール**

- `podcast_id` と `target_id` はユニーク
- ステータスはユーザーが手動更新（MVP）
- バリデーションNG等で `needs_attention` を付けられる

---

### 3.7 AdminUser（管理者）

**概要**：管理画面ログイン用。MVPでは単一前提。

**主な属性**

- `id`
- `email`
- `password_hash`
- `created_at`

**ドメインルール**

- MVPでは権限/ロールは持たない
- パスワードはハッシュ化必須

---

## 4. 関係（Relationships）

- Podcast 1 --- \* Episode
- Episode 1 --- 0..1 Asset（audio）
- Podcast 1 --- 0..1 Asset（cover image）
- Podcast 1 --- 0..1 FeedToken
- Podcast 1 --- \* DistributionStatus
- DistributionStatus \* --- 1 DistributionTarget

---

## 5. 集約（Aggregates）と整合性

### 5.1 Podcast 集約

- ルート：`Podcast`
- 子：`Episode`（実装上は別テーブルでもOKだが、整合性はPodcast単位で担保）
- 付随：`FeedToken`、`DistributionStatus`

**整合性ルール**

- Podcast削除時は Episode / Token / DistributionStatus / Asset参照を整理（CASCADE方針を明確化）

### 5.2 Episode 集約

- ルート：`Episode`
- 付随：`audio Asset`

**整合性ルール**

- `published` になるには audio が必須
- audio差し替え時はRSS enclosure情報が更新される

---

## 6. 主要なドメインルール（Business Rules）

### 6.1 公開/非公開RSS

- `Podcast.visibility=public`
  - 公開RSS：有効
  - 非公開RSS：任意（将来のため発行はしても良い）
- `Podcast.visibility=private`
  - 公開RSS：無効（404 or 403）
  - 非公開RSS：token必須で有効

### 6.2 RSSへの掲載条件

- Episode `status=published` のみRSSに含める
- `published_at` の降順/昇順はRSS仕様に合わせる（通常は公開日時順）

### 6.3 音声形式許可（MVP）

- MP3 / M4A / WAV のみ
- MIME/拡張子は双方チェック（ただしMIMEを優先）
- `byte_size` は必須（RSS enclosureに必須）

### 6.4 配信先ステータス（手動）

- DistributionStatusはユーザーが更新
- 「提出ウィザード」はsubmit_urlとRSS URLの提示が主

---

## 7. ドメインイベント（任意：将来拡張用）

MVPでは必須ではないが、将来の拡張（キャッシュ無効化、通知、監査ログ）を見据えイベント候補を定義する。

- `PodcastUpdated`
- `EpisodePublished`
- `EpisodeUnpublished`
- `AudioAssetReplaced`
- `FeedTokenRotated`
- `DistributionStatusChanged`

---

## 8. 代表的ユースケースとデータフロー

### 8.1 番組作成 → RSS発行

1. Podcast作成
2. FeedToken（private用）を必要に応じて発行
3. RSSエンドポイントがPodcastメタ情報と公開EpisodeからXML生成

### 8.2 エピソード公開

1. Episode作成（draft）
2. audio Assetアップロード → `audio_asset_id`紐付け
3. statusを `published` に変更（published_at必須）
4. RSSに即反映

### 8.3 配信先登録（半自動）

1. DistributionタブでRSS URLをコピー
2. submit_urlへ移動して提出（ユーザー操作）
3. poddockに戻って statusを `submitted` / `live` に更新

---

## 9. ID・命名・永続化の方針（推奨）

- ID：UUID v7 or ULID（ソートしやすい）
- Timestamp：UTC保存（表示はJST）
- 参照整合性：DB FK で担保
- 削除：MVPは物理削除でも可（将来はソフトデリート検討）

---

## 10. MVPでの割り切り

- 多ユーザー/権限管理は行わない
- アナリティクスは保持しない
- 自動提出（API提出完了）は行わない（半自動のみ）
- 再エンコードは行わない（アップロード形式をそのまま配信）

---

## 11. 補足：派生値について

- `channel/link` は Podcast エンティティに保持しない
- RSS生成時に以下の規則で自動構築する派生値とする

**生成ルール（MVP）**

```
https://poddock.example.com/podcasts/{podcastId}
```

> ※ URL設計変更時の影響を最小化するため、DBには永続化しない

---
