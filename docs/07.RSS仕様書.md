# RSS仕様書.md（poddock / MVP）

> 対象：poddock が発行する Podcast RSS（RSS 2.0 + iTunes拡張）
> 目的：Apple Podcasts / Spotify / Amazon Music に"通る"RSSを安定して生成し、バリデーション実装の仕様根拠にする

---

## 1. 参照仕様（ソース）

- Apple Podcasts for Creators: Podcast RSS feed requirements
- Apple Podcasts: Validate your podcast RSS feed（代表的なエラー原因）
- Spotify: Podcast Delivery Specification v1.10（RSS/音声/画像/キャッシュ観点）
- Amazon Music: RSS提出ページ（提出の起点）
- Amazon Music FAQ（RSS内 `itunes:email` 必須の言及）
- Apple Artwork guide（アートワーク要件の参照）

---

## 2. RSSの基本仕様

### 2.1 形式

- RSS 2.0準拠
- XML 1.0 / UTF-8
- タグ名・属性名は **大小文字を厳密に区別**（case-sensitive）

### 2.2 ルート要素と名前空間

最低限、以下を含むこと（poddockの推奨）。

- `xmlns:itunes="http://www.itunes.com/dtds/podcast-1.0.dtd"`
- `xmlns:content="http://purl.org/rss/1.0/modules/content/"`（任意だがApple例に記載）
- `xmlns:media="http://search.yahoo.com/mrss/"`（Spotifyの仕様で言及）
- `version="2.0"`

**例（骨格）**

```xml
<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0"
  xmlns:itunes="http://www.itunes.com/dtds/podcast-1.0.dtd"
  xmlns:content="http://purl.org/rss/1.0/modules/content/"
  xmlns:media="http://search.yahoo.com/mrss/">
  <channel> ... </channel>
</rss>
```

---

## 3. サーバ要件（配信インフラ）

### 3.1 HTTP HEAD と byte-range

- Apple は、ホスティング側が HTTP HEAD と byte-range request に対応することを要求
- 音声ストリーミングやアートワーク表示に必要

### 3.2 キャッシュ制御（推奨）

- Spotify はRSSを「数回/時」チェックし、ETag / Last-Modified を尊重して不要な再取得を抑制する旨を記載

**poddock推奨**

- RSSレスポンスに ETag と Last-Modified を付与
- 更新時は確実に値を更新（Spotify側の差分検知を促す）

> **注意**：Spotify仕様では「バイナリだけ差し替えてURLが変わらないと更新されない」旨の言及があるため、音声差し替えはURL/パス変更を伴う設計が安全（poddockでは asset_id でキーを変えるなど）

---

## 4. 文字列・日付・URLのルール

### 4.1 日付フォーマット

- Apple は pubDate が RFC 2822 形式であることを要求（タイムゾーンオフセット必須）
- 例：`Wed, 6 Jul 2014 13:00:00 -0700`

### 4.2 URLとファイル名

- Apple は ASCIIのファイル名/URL を推奨（a-z, A-Z, 0-9）

**poddock方針**

- 音声URL・画像URLは ASCII安全文字で構成
- 署名付きURLは可（ただし期限切れに注意。RSSに載せるなら長期有効 or CDN固定URL推奨）

### 4.3 エスケープ

- `&` は必ず `&amp;`（Apple/Spotify双方で一般ルールとして重要）
- Appleは `&apos;` / `&quot;` の使用を推奨し、HTML系の `&rsquo;` などを避けるよう記載

---

## 5. Channel（番組）レベルの必須/推奨タグ

### 5.1 必須（MVPで必ず出す）

- `channel/title`（番組名）
- `channel/link`（番組のWebページURL：poddock番組ページ等）
- `channel/description`（番組説明）
- `channel/language`
- `itunes:author`
- `itunes:explicit`
- `itunes:category`（Appleのカテゴリ運用に重要）
- `itunes:image`（番組アートワークURL）

> Appleは「Required tags」「Artwork」「少なくとも1エピソード」を満たすことを前提としている

#### channel/link の生成ルール

- `channel/link` はRSS生成時に自動構築する
- 永続データとしては保持しない

**生成ルール（MVP）**

```
https://poddock.example.com/podcasts/{podcastId}
```

> ※ 当該URLは番組の紹介ページ（RSS URL・番組概要を表示）を想定する
> ※ 再生機能は提供しない

### 5.2 Amazon向け追加（必須扱い推奨）

- `itunes:email`（Amazon Music提出の要件として言及）

#### itunes:email の扱い

- `itunes:email` は Podcast に設定された `contact_email` を使用する
- Amazon Music への配信を行う場合、必須タグとして扱う
- `contact_email` が未設定の場合：
  - Amazon配信を選択している場合 → バリデーションエラー
  - それ以外 → `itunes:email` タグを出力しない

### 5.3 任意（MVPで出して良い）

- `copyright`
- `itunes:type`（episodic/serial 等。Spotify仕様にも項目あり）
- `image`（RSS標準の channel/image。任意）

---

## 6. Item（エピソード）レベルの必須/推奨タグ

### 6.1 必須（MVPで必ず出す）

- `item/title`
- `item/description`（短文でも可）
- `item/pubDate`（RFC 2822）
- `item/guid`（グローバル一意で不変）
- `item/enclosure`（音声ファイル）

### 6.2 enclosure の必須要件（最重要）

**Apple要件：**

- 各エピソードは ユニークな `<enclosure>` を持つこと
- `<enclosure>` は `url` `length` `type` の3要素が必須
- 重複 enclosure url は無視され得る

**poddockルール**

- `url`：asset.public_url
- `length`：asset.byte_size（必須）
- `type`：asset.content_type（必須）

### 6.3 推奨（MVPで出すと強い）

- `itunes:duration`（秒 or HH:MM:SS）
- `itunes:explicit`（番組と同値でよい）
- `itunes:episode` / `itunes:season` / `itunes:episodeType`（任意、将来対応）
- `itunes:image`（エピソード個別画像。MVPは任意）

> Spotify仕様では `itunes:duration` や `guid`/`enclosure` などを要素として定義している

---

## 7. 音声フォーマット（MVP対応）と type の指定

### 7.1 poddock の対応形式（MVP）

| 形式 | type |
|------|------|
| MP3 | `audio/mpeg` |
| M4A（AAC） | `audio/mp4` |
| WAV | `audio/wav` |

### 7.2 Spotify観点（推奨エンコード）

Spotify Delivery Spec v1.10では、音声について以下を推奨：

- 高ビットレート MP3（128kbps+）
- または MP4 with AAC-LC

（※passthrough では MP3のみ、などの注意も記載）

**poddockのMVP方針**

- 受け入れ形式は MP3/M4A/WAV
- MVPでは再エンコードしない（アップロード形式をそのまま enclosure で配信）
- ただしガイドとして「Spotify推奨（MP3 128kbps+ or AAC-LC）」をUIに表示する

---

## 8. 画像（アートワーク）要件（MVP）

### 8.1 番組アートワーク

- `itunes:image href="..."`
- Appleはアートワーク要件を別途ガイドとして提供

**poddock推奨**

- 正方形（1:1）
- 高解像度（プラットフォームで縮小される前提）

> Spotify仕様も「1:1の正方形」「高解像度推奨」「形式はTIFF/PNG/JPEGを優先」などを記載
> （poddockはMVPでPNG/JPEGで十分）

---

## 9. 公開RSS / 非公開RSS（token）仕様（poddock独自）

### 9.1 公開RSS

- URL例：`https://poddock.example.com/rss/{podcastId}.xml`
- `visibility=public` のとき取得可能

### 9.2 非公開RSS

- URL例：`https://poddock.example.com/rss/{podcastId}.xml?token=xxxxx`
- `visibility=private` のとき こちらのみ有効
- tokenは推測困難な長いランダム文字列（FeedToken）

**レスポンス方針（推奨）**

- token無し / 不正token：404 か 403
- 「存在の秘匿」を優先するなら 404 が扱いやすい

---

## 10. poddock RSSバリデーション仕様（MVP）

poddockの「配信先連携（半自動）」で使用する内部チェック項目。

### 10.1 チェック項目（Channel）

- `title` / `link` / `description` / `language` の存在
- `itunes:author` / `itunes:explicit` / `itunes:category` / `itunes:image` の存在
- `itunes:email` の存在（Amazon提出想定）
- XMLがUTF-8であること（宣言含む）

### 10.2 チェック項目（Item）

- 公開エピソードが1件以上（Apple要件）
- `guid` が不変・ユニーク（Apple要件）
- `enclosure`（url, length, type）が揃っている（Apple要件）
- `pubDate` がRFC2822（Apple要件）

### 10.3 URL到達性（推奨）

- RSS URLが公開で取得できる（公開RSSの場合）
- 音声URLが 200 で取れる
- HEAD/Range が通る（Apple要件）

---

## 11. RSSサンプル（最小）

※実際の値はpoddockのPodcast/Episode/Assetから生成する
※サンプルは短縮版（必要最低限）

```xml
<rss version="2.0"
  xmlns:itunes="http://www.itunes.com/dtds/podcast-1.0.dtd"
  xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>Example Show</title>
    <link>https://poddock.example.com/podcasts/abc</link>
    <description>Example description</description>
    <language>ja</language>

    <itunes:author>Example Author</itunes:author>
    <itunes:explicit>false</itunes:explicit>
    <itunes:category text="Technology" />
    <itunes:image href="https://cdn.example.com/artwork/show.jpg" />
    <itunes:email>admin@example.com</itunes:email>

    <item>
      <title>Ep1</title>
      <description>Show notes...</description>
      <pubDate>Fri, 23 Jan 2026 12:00:00 +0900</pubDate>
      <guid isPermaLink="false">poddock:episode:ep1</guid>
      <enclosure
        url="https://cdn.example.com/audio/ep1.m4a"
        length="12345678"
        type="audio/mp4" />
      <itunes:duration>1234</itunes:duration>
    </item>
  </channel>
</rss>
```

---

## 12. 提出フロー（参照）

- **Spotify**：RSSベースの番組は podcasters.spotify.com から提出し、SpotifyのPodcast Delivery Specificationに準拠する
- **Amazon Music**：RSS URL を入力して提出を開始
- **Apple**：RSSが要件を満たさない場合、Feed validation errors になる
