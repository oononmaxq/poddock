# API設計.md（poddock / MVP）

> 方針：REST + JSON（管理API） / RSSはXML（配信API）
> ベースURL例：`https://api.poddock.example.com`（管理API）
> 公開RSS/音声配信は `https://poddock.example.com`（配信API）想定

---

## 1. 共通仕様

### 1.1 認証

- 管理APIはログイン必須（Bearer Token方式を推奨）
- RSS/音声ファイル取得は **公開/非公開ルール**に従い認証なしでアクセス可能

**ヘッダ**

```
Authorization: Bearer <token>
```

### 1.2 代表ステータスコード

| コード | 説明 |
|--------|------|
| `200 OK` | 取得成功 |
| `201 Created` | 作成成功 |
| `204 No Content` | 削除成功 |
| `400 Bad Request` | バリデーションエラー |
| `401 Unauthorized` | 未認証 |
| `403 Forbidden` | 権限不足（MVPでは基本未使用） |
| `404 Not Found` | 存在しない / 非公開秘匿 |
| `409 Conflict` | 一意制約違反 |
| `422 Unprocessable Entity` | 公開条件不足などドメイン整合性エラー |

### 1.3 共通エラーフォーマット

```json
{
  "error": {
    "code": "validation_error",
    "message": "Invalid request",
    "details": [
      { "field": "title", "reason": "required" }
    ]
  }
}
```

### 1.4 ID

- `podcastId` / `episodeId` / `assetId` は UUIDv7 または ULID を推奨

### 1.5 日時

- APIはISO8601（UTC）で返却
- UI表示はJST変換

---

## 2. 認証（Access）

### 2.1 ログイン

```
POST /auth/login
```

**Request**

```json
{
  "email": "admin@example.com",
  "password": "********"
}
```

**Response 200**

```json
{
  "access_token": "jwt_or_random_token",
  "token_type": "Bearer",
  "expires_in": 3600
}
```

### 2.2 ログアウト（任意：トークン無効化が必要なら）

```
POST /auth/logout
```

> MVPでは省略可（クライアント側で破棄）

---

## 3. Podcast API（Catalog）

### 3.1 番組一覧

```
GET /podcasts
```

**Query（任意）**

| パラメータ | 説明 |
|-----------|------|
| `q` | タイトル検索 |
| `visibility` | `public` \| `private` |
| `limit` | 取得件数 |
| `cursor` | ページネーション |

**Response 200**

```json
{
  "items": [
    {
      "id": "pod_01",
      "title": "Example Show",
      "visibility": "private",
      "cover_image_asset_id": "ast_01",
      "episode_counts": { "draft": 2, "published": 5 },
      "updated_at": "2026-01-23T03:00:00Z"
    }
  ],
  "next_cursor": null
}
```

### 3.2 番組作成

```
POST /podcasts
```

**Request**

```json
{
  "title": "Example Show",
  "description": "About this show",
  "language": "ja",
  "category": "Technology",
  "author_name": "Example Author",
  "explicit": false,
  "visibility": "private",
  "contact_email": "contact@example.com",
  "cover_image_asset_id": null
}
```

**Response 201**

```json
{
  "id": "pod_01",
  "title": "Example Show",
  "visibility": "private",
  "public_rss_url": "https://poddock.example.com/rss/pod_01.xml",
  "private_rss_url": "https://poddock.example.com/rss/pod_01.xml?token=xxxxx",
  "created_at": "2026-01-23T03:00:00Z",
  "updated_at": "2026-01-23T03:00:00Z"
}
```

> `public_rss_url` / `private_rss_url` は派生値として返す（DBに保持しない）

### 3.3 番組取得

```
GET /podcasts/{podcastId}
```

**Response 200**

```json
{
  "id": "pod_01",
  "title": "Example Show",
  "description": "About this show",
  "language": "ja",
  "category": "Technology",
  "author_name": "Example Author",
  "explicit": false,
  "visibility": "private",
  "contact_email": "contact@example.com",
  "cover_image_asset_id": "ast_img_01",
  "public_rss_url": "https://poddock.example.com/rss/pod_01.xml",
  "private_rss_url": "https://poddock.example.com/rss/pod_01.xml?token=xxxxx",
  "created_at": "2026-01-23T03:00:00Z",
  "updated_at": "2026-01-23T03:10:00Z"
}
```

### 3.4 番組更新

```
PATCH /podcasts/{podcastId}
```

**Request（部分更新）**

```json
{
  "description": "Updated description",
  "visibility": "public",
  "contact_email": "contact@example.com"
}
```

**Response 200**：`GET /podcasts/{id}` と同形

### 3.5 番組削除

```
DELETE /podcasts/{podcastId}
```

**Response 204**

---

## 4. Episode API（Catalog）

### 4.1 エピソード一覧

```
GET /podcasts/{podcastId}/episodes
```

**Query（任意）**

| パラメータ | 説明 |
|-----------|------|
| `status` | `draft` \| `published` |
| `limit` | 取得件数 |
| `cursor` | ページネーション |

**Response 200**

```json
{
  "items": [
    {
      "id": "ep_01",
      "podcast_id": "pod_01",
      "title": "Ep1",
      "status": "draft",
      "published_at": null,
      "audio_asset_id": null,
      "audio": null,
      "updated_at": "2026-01-23T03:20:00Z"
    }
  ],
  "next_cursor": null
}
```

### 4.2 エピソード作成

```
POST /podcasts/{podcastId}/episodes
```

**Request**

```json
{
  "title": "Ep1",
  "description": "Show notes...",
  "status": "draft",
  "published_at": null
}
```

**Response 201**

```json
{
  "id": "ep_01",
  "podcast_id": "pod_01",
  "title": "Ep1",
  "description": "Show notes...",
  "status": "draft",
  "published_at": null,
  "audio_asset_id": null,
  "created_at": "2026-01-23T03:20:00Z",
  "updated_at": "2026-01-23T03:20:00Z"
}
```

### 4.3 エピソード取得

```
GET /podcasts/{podcastId}/episodes/{episodeId}
```

**Response 200**

```json
{
  "id": "ep_01",
  "podcast_id": "pod_01",
  "title": "Ep1",
  "description": "Show notes...",
  "status": "draft",
  "published_at": null,
  "audio_asset_id": "ast_aud_01",
  "audio": {
    "asset_id": "ast_aud_01",
    "public_url": "https://cdn.example.com/audio/ep1.m4a",
    "content_type": "audio/mp4",
    "byte_size": 12345678
  },
  "created_at": "2026-01-23T03:20:00Z",
  "updated_at": "2026-01-23T03:30:00Z"
}
```

### 4.4 エピソード更新

```
PATCH /podcasts/{podcastId}/episodes/{episodeId}
```

**Request例（公開）**

```json
{
  "status": "published",
  "published_at": "2026-01-23T04:00:00Z"
}
```

**ドメイン整合性**

- `status=published` の場合、`published_at` と `audio_asset_id` が必須
- 不足時は `422` で返す

**Response 200**：取得と同形

### 4.5 エピソード削除

```
DELETE /podcasts/{podcastId}/episodes/{episodeId}
```

**Response 204**

---

## 5. Asset / Upload API（Media）

MVPでは「署名付きアップロード」か「API経由アップロード」のどちらかを採用。
大きなファイルを想定するため、推奨は署名付き（S3/R2）。

### 5.1 アップロードURL発行（推奨）

```
POST /assets/upload-url
```

**Request**

```json
{
  "type": "audio",
  "file_name": "ep1.m4a",
  "content_type": "audio/mp4",
  "byte_size": 12345678
}
```

**Response 201**

```json
{
  "asset_id": "ast_aud_01",
  "upload": {
    "method": "PUT",
    "url": "https://storage-signed-url...",
    "headers": { "Content-Type": "audio/mp4" },
    "expires_in": 900
  }
}
```

### 5.2 アップロード確定（メタ登録）

```
POST /assets/{assetId}/complete
```

**Request**

```json
{
  "storage_provider": "r2",
  "storage_bucket": "poddock",
  "storage_key": "audio/ast_aud_01",
  "public_url": "https://cdn.example.com/audio/ast_aud_01.m4a",
  "checksum": "optional"
}
```

**Response 200**

```json
{
  "id": "ast_aud_01",
  "type": "audio",
  "public_url": "https://cdn.example.com/audio/ast_aud_01.m4a",
  "content_type": "audio/mp4",
  "byte_size": 12345678,
  "created_at": "2026-01-23T03:25:00Z"
}
```

### 5.3 エピソードに音声を紐付け

```
POST /podcasts/{podcastId}/episodes/{episodeId}/audio
```

**Request**

```json
{
  "audio_asset_id": "ast_aud_01"
}
```

**Response 200**

```json
{
  "episode_id": "ep_01",
  "audio_asset_id": "ast_aud_01"
}
```

> 音声差し替えも同エンドポイントで上書き（MVP）。
> 差し替え時はRSS enclosureのURL/length/typeが更新される。

---

## 6. FeedToken API（Syndication）

### 6.1 非公開RSS token再発行（任意）

```
POST /podcasts/{podcastId}/feed-token/rotate
```

**Response 200**

```json
{
  "private_rss_url": "https://poddock.example.com/rss/pod_01.xml?token=newtoken",
  "rotated_at": "2026-01-23T03:40:00Z"
}
```

---

## 7. RSS Validation API（Syndication）

### 7.1 RSS要件チェック（内部バリデーション）

```
POST /podcasts/{podcastId}/rss/validate
```

**Request（任意：対象配信先）**

```json
{
  "targets": ["apple", "spotify", "amazon"]
}
```

**Response 200**

```json
{
  "ok": false,
  "results": [
    {
      "target": "amazon",
      "ok": false,
      "errors": [
        {
          "code": "missing_itunes_email",
          "message": "Amazon向けに itunes:email が必要です",
          "field": "contact_email",
          "action": "番組設定で連絡先メールを入力してください"
        }
      ],
      "warnings": []
    },
    {
      "target": "apple",
      "ok": true,
      "errors": [],
      "warnings": [
        {
          "code": "missing_cover_image",
          "message": "アートワーク未設定です（推奨）",
          "action": "番組カバー画像を設定してください"
        }
      ]
    }
  ]
}
```

---

## 8. Distribution（配信先ステータス）API

### 8.1 配信先ステータス一覧

```
GET /podcasts/{podcastId}/distribution-statuses
```

**Response 200**

```json
{
  "items": [
    {
      "target_id": "apple",
      "status": "not_submitted",
      "note": null,
      "submit_url": "https://...",
      "updated_at": "2026-01-23T03:00:00Z"
    },
    {
      "target_id": "spotify",
      "status": "submitted",
      "note": "審査中",
      "submit_url": "https://...",
      "updated_at": "2026-01-23T03:10:00Z"
    }
  ]
}
```

### 8.2 配信先ステータス更新

```
PATCH /podcasts/{podcastId}/distribution-statuses/{targetId}
```

**Request**

```json
{
  "status": "live",
  "note": "公開確認済み",
  "last_checked_at": "2026-01-23T03:50:00Z"
}
```

**Response 200**

```json
{
  "target_id": "spotify",
  "status": "live",
  "note": "公開確認済み",
  "last_checked_at": "2026-01-23T03:50:00Z",
  "updated_at": "2026-01-23T03:50:00Z"
}
```

---

## 9. 配信API（Public）

> ※管理APIとは別ドメインでもよい

### 9.1 公開RSS

```
GET https://poddock.example.com/rss/{podcastId}.xml
```

- `visibility=public` の場合：200（XML）
- `visibility=private` の場合：404 or 403（推奨：404）

### 9.2 非公開RSS

```
GET https://poddock.example.com/rss/{podcastId}.xml?token=xxxxx
```

- token有効：200（XML）
- token無効/なし：404 or 403（推奨：404）

### 9.3 番組ページ（channel/link 用）

```
GET https://poddock.example.com/podcasts/{podcastId}
```

- 番組概要 / RSS URL 表示（再生はしない）
- 公開/非公開の表示制御は要検討（privateの場合は管理者のみ閲覧 or 404）

---

## 10. ドメイン整合性チェック一覧（実装必須）

### 10.1 Episode公開条件（422）

`status=published` のとき：

- `published_at` が必須
- `audio_asset_id` が必須

### 10.2 Audio Assetの形式（400）

`content_type` が以下以外は拒否：

- `audio/mpeg`
- `audio/mp4`
- `audio/wav`

### 10.3 Amazon向け（validateでNG）

- Amazonを対象にvalidateしたとき `contact_email` が未設定ならNG

---

## 11. MVPでの割り切り

- 「完全自動提出（Apple/Spotify/AmazonへAPIで登録完了）」は行わない
- 配信先ステータスは手動管理（ウィザード支援のみ）
- アナリティクス/課金/複数権限は対象外
