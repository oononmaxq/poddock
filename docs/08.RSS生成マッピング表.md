# RSS生成マッピング表.md（poddock / MVP）

> 目的：DB（Podcast/Episode/Asset/FeedToken）からRSS(XML)を生成する際の「ソース→タグ→変換ルール」を定義する  
> 対象：RSS 2.0 + iTunes拡張（Apple/Spotify/Amazonの共通最小）

---

## 0. 前提

- RSSは `Podcast` 単位で生成（1 Podcast = 1 feed）
- RSSに含めるEpisodeは `Episode.status = published` のみ
- `enclosure` は `Asset(type=audio)` の `public_url / byte_size / content_type` を使用
- `itunes:email` は `Podcast.contact_email` を使用（Amazon対象時は必須）
- `channel/link` は派生値（DBに保持しない）
  - 例：`https://poddock.example.com/podcasts/{podcastId}`
- pubDateはRFC 2822で出力（RSS要求）

---

## 1. Channel（番組）レベル マッピング

| XMLタグ                 | ソース（DB）                                       | 型/例              | 変換・生成ルール                                     | 必須     | 備考                          |
| ----------------------- | -------------------------------------------------- | ------------------ | ---------------------------------------------------- | -------- | ----------------------------- |
| `rss/@version`          | 定数                                               | `2.0`              | 固定                                                 | ✅       |                               |
| `rss/@xmlns:itunes`     | 定数                                               | URL                | 固定 `http://www.itunes.com/dtds/podcast-1.0.dtd`    | ✅       |                               |
| `rss/@xmlns:content`    | 定数                                               | URL                | 固定 `http://purl.org/rss/1.0/modules/content/`      | 推奨     |                               |
| `rss/@xmlns:media`      | 定数                                               | URL                | 固定 `http://search.yahoo.com/mrss/`                 | 推奨     | Spotify向け                   |
| `channel/title`         | `Podcast.title`                                    | `"Example Show"`   | XMLエスケープ                                        | ✅       |                               |
| `channel/description`   | `Podcast.description`                              | `"About..."`       | XMLエスケープ。長文OK                                | ✅       |                               |
| `channel/language`      | `Podcast.language`                                 | `ja`               | 未設定時 `ja`                                        | ✅       |                               |
| `channel/link`          | 派生                                               | URL                | `BASE_WEB/podcasts/{podcastId}` を組み立て           | ✅       | DBに持たない                  |
| `channel/lastBuildDate` | 派生                                               | RFC2822            | `max(channel更新時刻, 最新公開ep更新時刻)` をRFC2822 | 推奨     | キャッシュ/更新通知に有効     |
| `channel/pubDate`       | 派生                                               | RFC2822            | `最初の公開epのpublished_at` or `created_at`         | 任意     |                               |
| `itunes:author`         | `Podcast.author_name`                              | `"Example Author"` | 未設定時は空にしない（後述のfallback）               | 推奨     | Apple/Spotifyで使われる       |
| `itunes:summary`        | `Podcast.description`                              |                    | descriptionを流用（短くしたい場合は別項目）          | 推奨     |                               |
| `itunes:explicit`       | `Podcast.explicit`                                 | `false`            | boolean→`true/false`                                 | ✅       |                               |
| `itunes:category/@text` | `Podcast.category`                                 | `"Technology"`     | カテゴリ値をそのまま（後でマスタ化推奨）             | ✅       |                               |
| `itunes:image/@href`    | `Podcast.cover_image_asset_id -> Asset.public_url` | URL                | cover未設定時：バリデーション警告（MVPは許容）       | 推奨     |                               |
| `itunes:email`          | `Podcast.contact_email`                            | email              | 未設定時：通常は出力しない。Amazon対象時はNG         | 条件付き | Amazon提出をMVPに含むため重要 |
| `image/url`             | `cover_image_asset_id -> Asset.public_url`         | URL                | `itunes:image` と同値でOK                            | 任意     | RSS標準image                  |
| `image/title`           | `Podcast.title`                                    |                    |                                                      | 任意     |                               |
| `image/link`            | 派生                                               | URL                | `channel/link` と同値                                | 任意     |                               |

### 1.1 Fallbackルール（Channel）

- `itunes:author` が空の場合：
  - 優先：`Podcast.author_name`
  - 代替：会社名固定（例：`poddock` or `Izanami`等）※プロダクト方針で決める
- `channel/link` は常に生成可能にする（webページが簡素でもOK）

---

## 2. Item（エピソード）レベル マッピング

| XMLタグ              | ソース（DB）                                 | 型/例                  | 変換・生成ルール                                     | 必須   | 備考                      |
| -------------------- | -------------------------------------------- | ---------------------- | ---------------------------------------------------- | ------ | ------------------------- | ---- | ---- |
| `item/title`         | `Episode.title`                              | `"Ep1"`                | XMLエスケープ                                        | ✅     |                           |
| `item/description`   | `Episode.description`                        | `"Show notes"`         | 未設定時は空文字ではなく短い既定文（推奨）           | ✅     |                           |
| `item/pubDate`       | `Episode.published_at`                       | RFC2822                | `published_at` をRFC2822へ変換（TZ含む）             | ✅     | Apple要件                 |
| `item/guid`          | `Episode.id`                                 | `poddock:episode:{id}` | **不変**。`isPermaLink="false"` 推奨                 | ✅     | Apple要件：一意/不変      |
| `enclosure/@url`     | `Episode.audio_asset_id -> Asset.public_url` | URL                    | 音声URL（安定URL）                                   | ✅     | Apple要件                 |
| `enclosure/@length`  | `... -> Asset.byte_size`                     | int                    | byte数（必須）                                       | ✅     | Apple要件                 |
| `enclosure/@type`    | `... -> Asset.content_type`                  | MIME                   | MP3=`audio/mpeg` / M4A=`audio/mp4` / WAV=`audio/wav` | ✅     | Apple要件                 |
| `itunes:duration`    | `Episode.duration_seconds`                   | `HH:MM:SS`             | 秒→`H:MM:SS` 形式。未設定なら省略（将来自動抽出可）  | 推奨   |                           |
| `itunes:explicit`    | `Podcast.explicit`                           | `false`                | 番組値を継承                                         | 推奨   |                           |
| `itunes:episode`     | `Episode.episode_number`                     | int                    | MVPでは未実装なら出さない                            | 任意   | 将来                      |
| `itunes:season`      | `Episode.season_number`                      | int                    | MVPでは未実装なら出さない                            | 任意   | 将来                      |
| `itunes:episodeType` | 派生                                         | `full                  | trailer                                              | bonus` | MVPでは固定 `full` か省略 | 任意 | 将来 |
| `itunes:image/@href` | `Episode.image_asset_id -> Asset.public_url` | URL                    | MVPでは未実装なら出さない                            | 任意   | 将来                      |

### 2.1 Fallbackルール（Item）

- `item/description` が空の場合：
  - 推奨：`"Episode details on poddock"` のような短い既定文を出力（空要素は避ける）
- `enclosure` の3属性が揃わない場合：
  - **RSS生成自体は可能でも、バリデーションではNG**
  - `Episode.status=published` にできない（APIで422）

---

## 3. RSS生成アルゴリズム（疑似仕様）

### 3.1 対象エピソード選定

- `Episode.podcast_id = {podcastId}`
- `Episode.status = published`
- 並び順：`published_at DESC`（一般的な運用）

### 3.2 RSSキャッシュ指針（推奨）

- RSSレスポンスに `ETag` と `Last-Modified` を付与
- `Last-Modified` は `max(Podcast.updated_at, max(Episode.updated_at))`
- 304応答に対応

---

## 4. バリデーション（DB→RSS生成前チェック）

### 4.1 Channel必須チェック（MVP）

- `Podcast.title` 存在
- `Podcast.description` 存在
- `Podcast.language` 存在（未設定時 `ja`）
- `Podcast.category` 存在
- `Podcast.explicit` 存在（boolean）
- `channel/link` の組み立て可能（BASE_WEB設定があること）

### 4.2 Amazon対象時チェック（MVP）

- `Podcast.contact_email` 存在（未設定ならエラー）

### 4.3 Item必須チェック（publishedのみ）

- `Episode.published_at` 存在
- `Episode.audio_asset_id` 存在
- `Asset.public_url` / `Asset.byte_size` / `Asset.content_type` 存在

---

## 5. 生成されるURL一覧（派生値）

| 用途                       | 生成ルール（例）                                                |
| -------------------------- | --------------------------------------------------------------- |
| 公開RSS                    | `https://poddock.example.com/rss/{podcastId}.xml`               |
| 非公開RSS                  | `https://poddock.example.com/rss/{podcastId}.xml?token={token}` |
| channel/link（番組ページ） | `https://poddock.example.com/podcasts/{podcastId}`              |

---

## 6. MIME対応表（MVP）

| 形式     | 拡張子例 | `Asset.content_type` | enclosure `type` |
| -------- | -------- | -------------------- | ---------------- |
| MP3      | `.mp3`   | `audio/mpeg`         | `audio/mpeg`     |
| M4A(AAC) | `.m4a`   | `audio/mp4`          | `audio/mp4`      |
| WAV      | `.wav`   | `audio/wav`          | `audio/wav`      |

---

## 7. 実装メモ（事故防止）

- `guid` は **絶対に変えない**（タイトル変更などで変化させない）
- 音声差し替えは `public_url` が確実に変わる設計が安全（Assetを新規発行推奨）
- `byte_size` はアップロード完了時に確定させる（未確定なら公開不可）
- `&` を含む文字列は必ずXMLエスケープ（`&amp;`）

---
