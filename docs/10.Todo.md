# poddock Todo（MVP）

> 本ドキュメントは実装前に必要な作業を網羅的に列挙する

---

## 0. 未決事項の確定（実装前に決める）

技術選定.md セクション7 に記載の未決事項を確定する。
→ **QUESTIONS.md にてデフォルト採用で確定済み**

- [x] DB選定：D1で開始 or 最初からPostgres（Neon等） → **D1で開始**
- [x] 認証方式：JWTのみ or refresh token導入 → **JWTのみ**
- [x] 公開RSSのprivate時挙動：404 or 403（推奨は404） → **404**
- [x] R2公開URLの設計（バケット名/パス構造/キャッシュ戦略） → **{bucket}/audio/{assetId}.{ext}**
- [x] 本番ドメイン決定（例：poddock.example.com） → **環境変数 BASE_URL で設定**
- [x] 管理者アカウント初期作成方法（CLI / シード / 手動） → **シードデータ**

---

## 1. ドキュメント整備

### 1.1 整合性確認（完了済み）

- [x] 要件定義 ← スコープ定義書
- [x] 画面設計 ← 要件定義
- [x] ドメイン設計 ← 要件定義
- [x] ER図 ← ドメイン設計
- [x] RSS仕様書 ← 要件定義・ドメイン設計
- [x] API設計 ← ER図
- [x] RSS生成マッピング表 ← RSS仕様書
- [x] 技術選定 ← 要件定義・ドメイン設計

### 1.2 追加ドキュメント（任意）

- [ ] DBスキーマ定義書（ER図から生成 or D1マイグレーションで代替）
- [ ] 環境変数一覧（Workers/R2/D1の設定キー）
- [ ] デプロイ手順書

---

## 2. 環境構築

### 2.1 Cloudflare

- [ ] Cloudflareアカウント準備
- [ ] Wrangler CLI インストール・認証
- [ ] Workers プロジェクト作成
- [ ] D1 データベース作成
- [ ] R2 バケット作成（audio / images）
- [ ] R2 公開アクセス設定（CDN経由）
- [ ] カスタムドメイン設定（任意）

### 2.2 ローカル開発環境

- [x] Node.js / pnpm 環境 → **package.json作成済み**
- [x] Astro プロジェクト初期化 → **astro.config.mjs作成済み**
- [x] Tailwind CSS 導入 → **@tailwindcss/vite設定済み**
- [x] daisyUI 導入 → **global.css設定済み**
- [x] View Transitions / ClientRouter 設定 → **Layout.astro設定済み**
- [x] Wrangler dev 環境（Workers ローカル実行） → **wrangler.toml作成済み**
- [x] D1 ローカルDB（wrangler d1） → **wrangler.toml設定済み**
- [x] R2 ローカルエミュレーション（miniflare） → **wrangler.toml設定済み**

---

## 3. データベース

### 3.1 スキーマ作成（ER図に基づく）

- [x] ADMIN_USER テーブル → **src/infrastructure/db/schema.ts**
- [x] PODCAST テーブル → **src/infrastructure/db/schema.ts**
- [x] EPISODE テーブル → **src/infrastructure/db/schema.ts**
- [x] ASSET テーブル → **src/infrastructure/db/schema.ts**
- [x] FEED_TOKEN テーブル → **src/infrastructure/db/schema.ts**
- [x] DISTRIBUTION_TARGET テーブル → **src/infrastructure/db/schema.ts**
- [x] DISTRIBUTION_STATUS テーブル → **src/infrastructure/db/schema.ts**

### 3.2 マイグレーション

- [x] 初期マイグレーションファイル作成 → **migrations/0000_init.sql**
- [ ] D1 マイグレーション実行確認

### 3.3 シードデータ

- [x] DistributionTarget 初期データ（apple / spotify / amazon） → **migrations/0001_seed.sql**
- [x] AdminUser 初期アカウント（開発用） → **migrations/0001_seed.sql**

---

## 4. API実装（Workers）

### 4.1 共通基盤

- [x] ルーティング設計（Hono等のフレームワーク検討） → **src/presentation/api/index.ts**
- [x] 認証ミドルウェア（JWT検証） → **src/presentation/api/middleware/auth.ts**
- [x] エラーハンドリング（共通エラーフォーマット） → **src/presentation/api/middleware/error-handler.ts**
- [x] CORS設定 → **hono/cors使用**
- [x] リクエストバリデーション → **Zod使用**

### 4.2 認証API（/auth）

- [x] POST /auth/login（ログイン・トークン発行） → **src/presentation/api/routes/auth.ts**
- [x] POST /auth/logout（任意） → **src/presentation/api/routes/auth.ts**

### 4.3 Podcast API（/podcasts）

- [x] GET /podcasts（一覧） → **src/presentation/api/routes/podcasts.ts**
- [x] POST /podcasts（作成） → **src/presentation/api/routes/podcasts.ts**
- [x] GET /podcasts/{podcastId}（取得） → **src/presentation/api/routes/podcasts.ts**
- [x] PATCH /podcasts/{podcastId}（更新） → **src/presentation/api/routes/podcasts.ts**
- [x] DELETE /podcasts/{podcastId}（削除） → **src/presentation/api/routes/podcasts.ts**

### 4.4 Episode API（/podcasts/{podcastId}/episodes）

- [x] GET /episodes（一覧） → **src/presentation/api/routes/episodes.ts**
- [x] POST /episodes（作成） → **src/presentation/api/routes/episodes.ts**
- [x] GET /episodes/{episodeId}（取得） → **src/presentation/api/routes/episodes.ts**
- [x] PATCH /episodes/{episodeId}（更新） → **src/presentation/api/routes/episodes.ts**
- [x] DELETE /episodes/{episodeId}（削除） → **src/presentation/api/routes/episodes.ts**

### 4.5 Asset API（/assets）

- [x] POST /assets/upload-url（署名付きURL発行） → **src/presentation/api/routes/assets.ts**
- [x] POST /assets/{assetId}/complete（アップロード完了登録） → **src/presentation/api/routes/assets.ts**
- [x] POST /episodes/{episodeId}/audio（音声紐付け） → **src/presentation/api/routes/episodes.ts**

### 4.6 FeedToken API

- [x] POST /podcasts/{podcastId}/feed-token/rotate（token再発行） → **src/presentation/api/routes/feed-token.ts**

### 4.7 Distribution API

- [x] GET /podcasts/{podcastId}/distribution-statuses（一覧） → **src/presentation/api/routes/distribution.ts**
- [x] PATCH /distribution-statuses/{targetId}（ステータス更新） → **src/presentation/api/routes/distribution.ts**

### 4.8 Validate API

- [x] POST /podcasts/{podcastId}/rss/validate（RSS要件チェック） → **src/presentation/api/routes/validate.ts**
  - [x] Apple向けチェック
  - [x] Spotify向けチェック
  - [x] Amazon向けチェック（contact_email必須）

### 4.9 ドメイン整合性チェック（API層）

- [x] Episode公開条件（published_at + audio_asset_id 必須） → **episodes.ts内で実装**
- [x] Audio Asset形式チェック（audio/mpeg, audio/mp4, audio/wav のみ） → **assets.ts内で実装**

---

## 5. RSS配信API（Workers）

### 5.1 公開RSS

- [x] GET /rss/{podcastId}.xml → **src/presentation/api/routes/rss.ts**
- [x] visibility=public 時のみ返却
- [x] visibility=private 時は404（or 403） → **404を返す**

### 5.2 非公開RSS

- [x] GET /rss/{podcastId}.xml?token=xxx → **src/presentation/api/routes/rss.ts**
- [x] token検証（FeedToken照合）
- [x] 無効token時は404

### 5.3 RSS生成ロジック

- [x] Channel（番組）レベルのXML生成（マッピング表に基づく） → **rss.ts generateRssXml()**
- [x] Item（エピソード）レベルのXML生成
- [x] RFC 2822 日付変換 → **src/infrastructure/utils/date.ts**
- [x] XMLエスケープ処理 → **rss.ts escapeXml()**
- [x] ETag / Last-Modified ヘッダ付与 → **rss.ts内で実装**

### 5.4 番組ページ（channel/link用）

- [x] GET /podcasts/{podcastId}（公開ページ） → **src/pages/podcasts/[podcastId]/public.astro**
- [x] 番組概要・RSS URL表示（再生機能なし）

---

## 6. フロントエンド実装（Astro）

### 6.1 レイアウト・共通コンポーネント

- [x] 管理画面レイアウト（ヘッダ・サイドバー） → **src/presentation/ui/layouts/Layout.astro**
- [x] 認証ガード（未ログイン時リダイレクト） → **各ページのscript内で実装**
- [x] CopyButton（RSS URLコピー） → **src/presentation/ui/components/CopyButton.astro**
- [x] StatusBadge（下書き/公開、配信先ステータス） → **src/presentation/ui/components/StatusBadge.astro**
- [ ] ValidationPanel（OK/NG一覧 + 修正ガイド）
- [x] DangerZone（削除など危険操作） → **各詳細ページ内に実装**
- [x] Toast通知 → **src/presentation/ui/components/Toast.astro**

### 6.2 認証画面

- [x] /login（ログイン画面） → **src/pages/login.astro**

### 6.3 ダッシュボード

- [x] /（番組一覧） → **src/pages/index.astro**
- [x] 空状態UI（番組0件時） → **src/pages/index.astro**

### 6.4 番組管理

- [x] /podcasts/new（番組作成） → **src/pages/podcasts/new.astro**
- [x] /podcasts/{podcastId}（番組詳細・タブ） → **src/pages/podcasts/[podcastId]/index.astro**
  - [x] Overview タブ（RSS・公開設定・メタ情報）
  - [x] Episodes タブ（エピソード一覧）
  - [x] Distribution タブ（配信先ウィザード・ステータス）
  - [x] Settings タブ（削除・token再発行）

### 6.5 エピソード管理

- [x] /podcasts/{podcastId}/episodes/new（エピソード作成） → **src/pages/podcasts/[podcastId]/episodes/new.astro**
- [x] /podcasts/{podcastId}/episodes/{episodeId}（エピソード編集） → **src/pages/podcasts/[podcastId]/episodes/[episodeId].astro**
- [x] 音声アップロードUI（ドラッグ&ドロップ・進捗表示） → **episodes/new.astro**
- [x] 形式チェック（MP3/M4A/WAV） → **episodes/new.astro**

### 6.6 RSS確認

- [x] /podcasts/{podcastId}/rss（RSS URL・プレビュー） → **番組詳細Overviewタブ内に統合**

### 6.7 配信先提出ウィザード

- [x] ウィザードUI（Step 1〜4） → **Distributionタブ + ヘルプページで代替**
- [x] RSS URLコピー導線 → **番組詳細Overview**
- [x] 外部リンク（Apple/Spotify/Amazon提出ページ） → **Distributionタブ**
- [x] ステータス更新UI → **Distributionタブ（APIのみ、UI未実装）**

### 6.8 ヘルプ

- [x] /help/distribution（配信先提出ヘルプ） → **src/pages/help/distribution.astro**

---

## 7. ストレージ（R2）

### 7.1 署名付きURL

- [x] PUTアップロード用署名URL生成 → **assets.ts（Workerプロキシ方式）**
- [x] 有効期限設定（15分等） → **expires_in: 900**

### 7.2 公開URL設計

- [x] 音声ファイルパス設計（例：audio/{assetId}.mp3） → **audio/{assetId}.{ext}**
- [x] 画像ファイルパス設計（例：images/{assetId}.jpg） → **image/{assetId}.{ext}**
- [ ] CDNキャッシュ設定

### 7.3 アップロードフロー

- [x] ブラウザ → R2 直接PUT → **Worker経由PUT（MVP）**
- [x] アップロード完了 → API呼び出し → DB登録 → **assets.ts**
- [x] エピソードへの紐付け → **episodes.ts /audio エンドポイント**

---

## 8. テスト

### 8.1 API テスト

- [x] 認証APIテスト → **jwt.test.ts, password.test.ts**
- [ ] Podcast CRUDテスト
- [ ] Episode CRUDテスト
- [ ] Asset アップロードフローテスト
- [ ] Distribution ステータス更新テスト

### 8.2 RSS テスト

- [x] RSS XML生成テスト → **rss.test.ts（ヘルパー関数）**
- [x] バリデーションテスト（Apple/Spotify/Amazon） → **rss.test.ts**
- [ ] 公開/非公開RSS アクセス制御テスト

### 8.3 E2E テスト（任意）

- [ ] ログイン → 番組作成 → エピソード作成 → 公開 フロー
- [ ] 配信先ウィザード フロー

---

## 9. デプロイ

### 9.1 環境変数設定

- [x] JWT_SECRET → **wrangler.toml / .dev.vars**
- [x] R2_BUCKET_NAME → **wrangler.tomlのbinding**
- [x] R2_PUBLIC_URL（CDN URL） → **wrangler.toml vars**
- [x] BASE_WEB_URL（channel/link生成用） → **BASE_URL として wrangler.toml vars**
- [x] その他必要な環境変数 → **env.d.ts で型定義済み**

### 9.2 Cloudflareデプロイ

- [ ] Workers デプロイ（wrangler deploy）
- [ ] D1 マイグレーション適用（本番）
- [ ] R2 バケット本番設定
- [ ] カスタムドメイン設定

### 9.3 動作確認

- [ ] 管理画面アクセス確認
- [ ] ログイン確認
- [ ] 番組作成 → RSS生成確認
- [ ] 音声アップロード確認
- [ ] RSS URL外部アクセス確認

---

## 10. MVP後の拡張（参考）

技術選定.md セクション5 に記載。MVPでは対象外。

- [ ] duration自動抽出（ffprobe相当）
- [ ] 画像リサイズ/最適化
- [ ] RSS外部到達性チェック（HEAD/Range）
- [ ] 孤児Asset掃除（Cron）
- [ ] ダークモード対応
- [ ] 複数ユーザー/権限管理
- [ ] アナリティクス

---

## 進捗サマリ

| カテゴリ | 完了 | 残り |
|---------|------|------|
| 未決事項 | 6 | 0 |
| ドキュメント | 8 | 3 |
| 環境構築 | 8 | 7 |
| データベース | 9 | 1 |
| API実装 | 25 | 0 |
| RSS配信 | 10 | 0 |
| フロントエンド | 23 | 2 |
| ストレージ | 5 | 1 |
| テスト | 4 | 6 |
| デプロイ | 5 | 5 |

---

最終更新：2026-01-24
