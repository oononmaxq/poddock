# poddock Todo（MVP）

> 本ドキュメントは実装前に必要な作業を網羅的に列挙する

---

## 0. 未決事項の確定（実装前に決める）

技術選定.md セクション7 に記載の未決事項を確定する。

- [ ] DB選定：D1で開始 or 最初からPostgres（Neon等）
- [ ] 認証方式：JWTのみ or refresh token導入
- [ ] 公開RSSのprivate時挙動：404 or 403（推奨は404）
- [ ] R2公開URLの設計（バケット名/パス構造/キャッシュ戦略）
- [ ] 本番ドメイン決定（例：poddock.example.com）
- [ ] 管理者アカウント初期作成方法（CLI / シード / 手動）

---

## 1. ドキュメント整備

### 1.1 整合性確認（完了済み）

- [x] 要件定義 ← スコープ定義書
- [x] 画面設計 ← 要件定義
- [x] ドメイン設計 ← 要件定義
- [x] ER図 ← ドメイン設計
- [x] RSS仕様書 ← 要件定義・ドメイン設計
- [x] API設計 ← ER図
- [x] RSS生成マッピング表 ← RSS仕様書
- [x] 技術選定 ← 要件定義・ドメイン設計

### 1.2 追加ドキュメント（任意）

- [ ] DBスキーマ定義書（ER図から生成 or D1マイグレーションで代替）
- [ ] 環境変数一覧（Workers/R2/D1の設定キー）
- [ ] デプロイ手順書

---

## 2. 環境構築

### 2.1 Cloudflare

- [ ] Cloudflareアカウント準備
- [ ] Wrangler CLI インストール・認証
- [ ] Workers プロジェクト作成
- [ ] D1 データベース作成
- [ ] R2 バケット作成（audio / images）
- [ ] R2 公開アクセス設定（CDN経由）
- [ ] カスタムドメイン設定（任意）

### 2.2 ローカル開発環境

- [ ] Node.js / pnpm 環境
- [ ] Astro プロジェクト初期化
- [ ] Tailwind CSS 導入
- [ ] daisyUI 導入
- [ ] View Transitions / ClientRouter 設定
- [ ] Wrangler dev 環境（Workers ローカル実行）
- [ ] D1 ローカルDB（wrangler d1）
- [ ] R2 ローカルエミュレーション（miniflare）

---

## 3. データベース

### 3.1 スキーマ作成（ER図に基づく）

- [ ] ADMIN_USER テーブル
- [ ] PODCAST テーブル
- [ ] EPISODE テーブル
- [ ] ASSET テーブル
- [ ] FEED_TOKEN テーブル
- [ ] DISTRIBUTION_TARGET テーブル
- [ ] DISTRIBUTION_STATUS テーブル

### 3.2 マイグレーション

- [ ] 初期マイグレーションファイル作成
- [ ] D1 マイグレーション実行確認

### 3.3 シードデータ

- [ ] DistributionTarget 初期データ（apple / spotify / amazon）
- [ ] AdminUser 初期アカウント（開発用）

---

## 4. API実装（Workers）

### 4.1 共通基盤

- [ ] ルーティング設計（Hono等のフレームワーク検討）
- [ ] 認証ミドルウェア（JWT検証）
- [ ] エラーハンドリング（共通エラーフォーマット）
- [ ] CORS設定
- [ ] リクエストバリデーション

### 4.2 認証API（/auth）

- [ ] POST /auth/login（ログイン・トークン発行）
- [ ] POST /auth/logout（任意）

### 4.3 Podcast API（/podcasts）

- [ ] GET /podcasts（一覧）
- [ ] POST /podcasts（作成）
- [ ] GET /podcasts/{podcastId}（取得）
- [ ] PATCH /podcasts/{podcastId}（更新）
- [ ] DELETE /podcasts/{podcastId}（削除）

### 4.4 Episode API（/podcasts/{podcastId}/episodes）

- [ ] GET /episodes（一覧）
- [ ] POST /episodes（作成）
- [ ] GET /episodes/{episodeId}（取得）
- [ ] PATCH /episodes/{episodeId}（更新）
- [ ] DELETE /episodes/{episodeId}（削除）

### 4.5 Asset API（/assets）

- [ ] POST /assets/upload-url（署名付きURL発行）
- [ ] POST /assets/{assetId}/complete（アップロード完了登録）
- [ ] POST /episodes/{episodeId}/audio（音声紐付け）

### 4.6 FeedToken API

- [ ] POST /podcasts/{podcastId}/feed-token/rotate（token再発行）

### 4.7 Distribution API

- [ ] GET /podcasts/{podcastId}/distribution-statuses（一覧）
- [ ] PATCH /distribution-statuses/{targetId}（ステータス更新）

### 4.8 Validate API

- [ ] POST /podcasts/{podcastId}/rss/validate（RSS要件チェック）
  - [ ] Apple向けチェック
  - [ ] Spotify向けチェック
  - [ ] Amazon向けチェック（contact_email必須）

### 4.9 ドメイン整合性チェック（API層）

- [ ] Episode公開条件（published_at + audio_asset_id 必須）
- [ ] Audio Asset形式チェック（audio/mpeg, audio/mp4, audio/wav のみ）

---

## 5. RSS配信API（Workers）

### 5.1 公開RSS

- [ ] GET /rss/{podcastId}.xml
- [ ] visibility=public 時のみ返却
- [ ] visibility=private 時は404（or 403）

### 5.2 非公開RSS

- [ ] GET /rss/{podcastId}.xml?token=xxx
- [ ] token検証（FeedToken照合）
- [ ] 無効token時は404

### 5.3 RSS生成ロジック

- [ ] Channel（番組）レベルのXML生成（マッピング表に基づく）
- [ ] Item（エピソード）レベルのXML生成
- [ ] RFC 2822 日付変換
- [ ] XMLエスケープ処理
- [ ] ETag / Last-Modified ヘッダ付与

### 5.4 番組ページ（channel/link用）

- [ ] GET /podcasts/{podcastId}（公開ページ）
- [ ] 番組概要・RSS URL表示（再生機能なし）

---

## 6. フロントエンド実装（Astro）

### 6.1 レイアウト・共通コンポーネント

- [ ] 管理画面レイアウト（ヘッダ・サイドバー）
- [ ] 認証ガード（未ログイン時リダイレクト）
- [ ] CopyButton（RSS URLコピー）
- [ ] StatusBadge（下書き/公開、配信先ステータス）
- [ ] ValidationPanel（OK/NG一覧 + 修正ガイド）
- [ ] DangerZone（削除など危険操作）
- [ ] Toast通知

### 6.2 認証画面

- [ ] /login（ログイン画面）

### 6.3 ダッシュボード

- [ ] /（番組一覧）
- [ ] 空状態UI（番組0件時）

### 6.4 番組管理

- [ ] /podcasts/new（番組作成）
- [ ] /podcasts/{podcastId}（番組詳細・タブ）
  - [ ] Overview タブ（RSS・公開設定・メタ情報）
  - [ ] Episodes タブ（エピソード一覧）
  - [ ] Distribution タブ（配信先ウィザード・ステータス）
  - [ ] Settings タブ（削除・token再発行）

### 6.5 エピソード管理

- [ ] /podcasts/{podcastId}/episodes/new（エピソード作成）
- [ ] /podcasts/{podcastId}/episodes/{episodeId}（エピソード編集）
- [ ] 音声アップロードUI（ドラッグ&ドロップ・進捗表示）
- [ ] 形式チェック（MP3/M4A/WAV）

### 6.6 RSS確認

- [ ] /podcasts/{podcastId}/rss（RSS URL・プレビュー）

### 6.7 配信先提出ウィザード

- [ ] ウィザードUI（Step 1〜4）
- [ ] RSS URLコピー導線
- [ ] 外部リンク（Apple/Spotify/Amazon提出ページ）
- [ ] ステータス更新UI

### 6.8 ヘルプ

- [ ] /help/distribution（配信先提出ヘルプ）

---

## 7. ストレージ（R2）

### 7.1 署名付きURL

- [ ] PUTアップロード用署名URL生成
- [ ] 有効期限設定（15分等）

### 7.2 公開URL設計

- [ ] 音声ファイルパス設計（例：audio/{assetId}.mp3）
- [ ] 画像ファイルパス設計（例：images/{assetId}.jpg）
- [ ] CDNキャッシュ設定

### 7.3 アップロードフロー

- [ ] ブラウザ → R2 直接PUT
- [ ] アップロード完了 → API呼び出し → DB登録
- [ ] エピソードへの紐付け

---

## 8. テスト

### 8.1 API テスト

- [ ] 認証APIテスト
- [ ] Podcast CRUDテスト
- [ ] Episode CRUDテスト
- [ ] Asset アップロードフローテスト
- [ ] Distribution ステータス更新テスト

### 8.2 RSS テスト

- [ ] RSS XML生成テスト
- [ ] バリデーションテスト（Apple/Spotify/Amazon）
- [ ] 公開/非公開RSS アクセス制御テスト

### 8.3 E2E テスト（任意）

- [ ] ログイン → 番組作成 → エピソード作成 → 公開 フロー
- [ ] 配信先ウィザード フロー

---

## 9. デプロイ

### 9.1 環境変数設定

- [ ] JWT_SECRET
- [ ] R2_BUCKET_NAME
- [ ] R2_PUBLIC_URL（CDN URL）
- [ ] BASE_WEB_URL（channel/link生成用）
- [ ] その他必要な環境変数

### 9.2 Cloudflareデプロイ

- [ ] Workers デプロイ（wrangler deploy）
- [ ] D1 マイグレーション適用（本番）
- [ ] R2 バケット本番設定
- [ ] カスタムドメイン設定

### 9.3 動作確認

- [ ] 管理画面アクセス確認
- [ ] ログイン確認
- [ ] 番組作成 → RSS生成確認
- [ ] 音声アップロード確認
- [ ] RSS URL外部アクセス確認

---

## 10. MVP後の拡張（参考）

技術選定.md セクション5 に記載。MVPでは対象外。

- [ ] duration自動抽出（ffprobe相当）
- [ ] 画像リサイズ/最適化
- [ ] RSS外部到達性チェック（HEAD/Range）
- [ ] 孤児Asset掃除（Cron）
- [ ] ダークモード対応
- [ ] 複数ユーザー/権限管理
- [ ] アナリティクス

---

## 進捗サマリ

| カテゴリ | 完了 | 残り |
|---------|------|------|
| 未決事項 | 0 | 6 |
| ドキュメント | 8 | 3 |
| 環境構築 | 0 | 15 |
| データベース | 0 | 10 |
| API実装 | 0 | 25 |
| RSS配信 | 0 | 10 |
| フロントエンド | 0 | 25 |
| ストレージ | 0 | 6 |
| テスト | 0 | 10 |
| デプロイ | 0 | 10 |

---

最終更新：2026-01-23
